<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Sharp QR Code Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, sans-serif; margin: 2rem; max-width: 700px; }
    h1 { margin-bottom: 1rem; }
    form { border: 1px solid #ddd; padding: 1rem; border-radius: 0.5rem; }
    .field-group { margin-bottom: 1rem; }
    label { display: block; margin-bottom: 0.25rem; }
    input[type="text"] { width: 100%; padding: 0.5rem; }
    input[type="file"] { padding: 0.25rem 0; }
    button { padding: 0.5rem 1rem; cursor: pointer; }
    .mode-select label { display: inline-block; margin-right: 1rem; }
    .qr-result { margin-top: 2rem; }
    .qr-result img { max-width: 250px; height: auto; border: 1px solid #ccc; padding: 0.5rem; }
    .flash { color: #b00020; margin-bottom: 0.5rem; }
    .card {
      border: 1px solid #ddd;
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1.5rem;
      background: #fafafa;
    }
  </style>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>
<body>
  <h1>Sharp QR Code Generator</h1>
  <p>Generate unlimited, ad‑free QR codes for URLs, text, or your own files.</p>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      {% for msg in messages %}
        <div class="flash">{{ msg }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  {% if not paid %}
    <div class="card">
      <h2>Unlock QR Generator</h2>
      <p>Pay once to unlock QR code generation on this device/browser.</p>
      <p><strong>Price:</strong> ₹{{ price_inr }}</p>
      <button type="button" onclick="startPayment()">Pay with Razorpay</button>
    </div>
  {% endif %}

  {% if paid %}
    <form method="post" enctype="multipart/form-data">
      <div class="field-group mode-select">
        <strong>Content type:</strong><br>
        <label>
          <input type="radio" name="mode" value="url" checked>
          URL or text
        </label>
        <label>
          <input type="radio" name="mode" value="file">
          File upload
        </label>
      </div>

      <div class="field-group" id="url-input">
        <label for="url">URL or text</label>
        <input
          type="text"
          id="url"
          name="url"
          placeholder="https://example.com or any text"
        >
      </div>

      <div class="field-group" id="file-input" style="display:none;">
        <label for="file">Choose a file</label>
        <input type="file" id="file" name="file">
        <small>Images, videos, PDFs, etc. (up to your configured limit).</small>
      </div>

      <button type="submit">Generate QR code</button>
    </form>
  {% else %}
    <p><em>Complete the payment above to enable QR code generation.</em></p>
  {% endif %}

  {% if qr_image_url %}
    <div class="qr-result">
      <h2>Your QR code</h2>
      <img src="{{ qr_image_url }}" alt="Generated QR code">
      {% if target_url %}
        <p>Scans of this code will open:</p>
        <p><a href="{{ target_url }}" target="_blank" rel="noopener noreferrer">{{ target_url }}</a></p>
      {% endif %}
      <p>You can download or share the QR image and it will stay valid as long as this app is running and the file (if any) exists.</p>
    </div>
  {% endif %}

  <script>
    const urlRadio = document.querySelector('input[name="mode"][value="url"]');
    const fileRadio = document.querySelector('input[name="mode"][value="file"]');
    const urlInput = document.getElementById('url-input');
    const fileInput = document.getElementById('file-input');

    function updateMode() {
      if (urlRadio && urlRadio.checked) {
        urlInput.style.display = '';
        fileInput.style.display = 'none';
      } else {
        urlInput.style.display = 'none';
        fileInput.style.display = '';
      }
    }

    if (urlRadio && fileRadio) {
      urlRadio.addEventListener('change', updateMode);
      fileRadio.addEventListener('change', updateMode);
      updateMode();
    }

    async function startPayment() {
      try {
        const res = await fetch("/create_order", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ amount: {{ price_inr }} })
        });
        const data = await res.json();
        if (!res.ok) {
          alert(data.error || "Failed to create order");
          return;
        }

        const options = {
          key: "{{ razorpay_key_id }}",
          amount: data.amount,            // in paise
          currency: data.currency,
          name: "Sharp QR Code Generator",
          description: "Unlock QR generator",
          order_id: data.order_id,
          // ABSOLUTE URL + redirect so Razorpay posts here and then sends you back. [web:73][web:74][web:79]
          callback_url: "{{ url_for('payment_handler', _external=True) }}",
          redirect: true,
          theme: { color: "#3399cc" }
        };

        const rzp = new Razorpay(options);
        rzp.on("payment.failed", function (resp) {
          alert("Payment failed or cancelled. Please try again.");
          console.log(resp.error);
        });
        rzp.open();
      } catch (e) {
        console.error(e);
        alert("Unexpected error while starting payment.");
      }
    }
  </script>
</body>
</html>
